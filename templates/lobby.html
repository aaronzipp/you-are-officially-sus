<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - You Are Officially Sus</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js" integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx-ext-sse@2.2.4" integrity="sha384-A986SAtodyH8eg8x8irJnYUk7i9inVQqYigD6qZ9evobksGNIXfeFvDwLSHcp31N" crossorigin="anonymous"></script>
    <script>
        // Minimal script: HTMX handles nav-redirect via HX-Location snippets
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('copy-code');
            const feedback = document.getElementById('copy-feedback');
            const code = '{{.RoomCode}}';

            function showFeedback(msg) {
                if (!feedback) return;
                feedback.textContent = msg;
                feedback.style.display = 'inline';
                setTimeout(() => {
                    feedback.style.display = 'none';
                    feedback.textContent = 'Copied!';
                }, 1500);
            }

            async function copyText(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (_) {}
                }
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.setAttribute('readonly', '');
                    ta.style.position = 'fixed';
                    ta.style.top = '-1000px';
                    ta.style.left = '-1000px';
                    document.body.appendChild(ta);
                    ta.select();
                    ta.setSelectionRange(0, ta.value.length);
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    return ok;
                } catch (_) {
                    return false;
                }
            }

            if (btn) {
                btn.addEventListener('click', async () => {
                    const ok = await copyText(code);
                    showFeedback(ok ? 'Copied!' : 'Copy failed');
                });
            }
        });
    </script>
</head>
<body hx-ext="sse" sse-connect="/sse/{{.RoomCode}}">
    <div class="container">
        <header>
            <h1>Room Lobby</h1>
            <div class="room-code-display">
                <strong>{{.RoomCode}}</strong>
                <div style="margin-top:0.5rem;">
                     <button id="copy-code" class="btn btn-compact" type="button" aria-label="Copy room code" title="Copy room code">Copy</button>
                     <span id="copy-feedback" class="text-muted" role="status" aria-live="polite" style="margin-left:0.5rem; display:none;">Copied!</span>
                </div>
            </div>
        </header>

        <main>
            <!-- Hidden elements for HTMX SSE consumption -->
            <div style="display:none;" sse-swap="nav-redirect"></div>
            
            <!-- Host notification message -->
            <div id="host-notification-display" sse-swap="host-changed"></div>
            
            {{if .IsHost}}
             <div id="host-controls" class="card sticky-top" sse-swap="controls-update" aria-label="Host controls">
                 {{if ge (len .Players) 3}}
                  <div class="button-stack">
                     <form hx-post="/start-game/{{.RoomCode}}">
                         <button type="submit" class="btn btn-primary" aria-label="Start game">Start Game</button>
                     </form>
                     <form hx-post="/close-lobby/{{.RoomCode}}">
                         <button type="submit" class="btn btn-danger" aria-label="Close lobby">Close Lobby</button>
                     </form>
                  </div>
                 {{else}}
                 <p>Waiting for players to join...</p>
                 <p class="text-muted">Need at least 3 players to start</p>
                  <div class="button-stack">
                     <form hx-post="/close-lobby/{{.RoomCode}}">
                         <button type="submit" class="btn btn-danger" aria-label="Close lobby">Close Lobby</button>
                     </form>
                  </div>
                 {{end}}
             </div>
            {{else}}
            <div id="host-controls" class="card sticky-top" sse-swap="controls-update">
                <p>Waiting for host to start the game...</p>
            </div>
            {{end}}

            <div id="player-list-card" class="card" sse-swap="player-update">
                <h2>Players ({{len .Players}})</h2>
                <ul class="player-list">
                    {{range .Players}}
                    <li class="player-item">
                        <span class="player-name">{{.Name}}</span>
                    </li>
                    {{end}}
                </ul>
            </div>

            {{if gt (len .Scores) 0}}
            <div id="score-card" class="card" sse-swap="score-update">
                <h2>Scores</h2>
                 <table class="score-table" aria-label="Scoreboard sorted by wins">
                     <thead>
                         <tr>
                             <th>Player</th>
                             <th aria-sort="descending" title="Sorted by wins (desc)">Wins â†“</th>
                             <th>Losses</th>
                         </tr>
                     </thead>
                    <tbody>
                        {{range .Players}}
                        {{$score := index $.Scores .ID}}
                        <tr>
                            <td class="score-player">{{.Name}}</td>
                            <td>
                                <span class="badge-pill badge-win">{{if $score}}{{$score.GamesWon}}{{else}}0{{end}}</span>
                            </td>
                            <td>
                                <span class="badge-pill badge-loss">{{if $score}}{{$score.GamesLost}}{{else}}0{{end}}</span>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            {{else}}
            <div id="score-card" class="card" sse-swap="score-update" style="display:none;">
            </div>
            {{end}}
        </main>

        <footer>
            <p>Share the room code with your friends!</p>
            <div style="margin-top: 1rem;">
                <form hx-post="/leave-lobby/{{.RoomCode}}">
                    {{if .IsHost}}
                    <button type="submit" class="btn btn-danger btn-compact" hx-confirm="Are you sure you want to leave? You are the host. Please choose a new host or they will be selected automatically if you disconnect." aria-label="Leave lobby">Leave Lobby</button>
                    {{else}}
                    <button type="submit" class="btn btn-danger btn-compact" hx-confirm="Are you sure you want to leave this lobby?" aria-label="Leave lobby">Leave Lobby</button>
                    {{end}}
                </form>
            </div>
        </footer>
    </div>
</body>
</html>
